<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>BooterSpace | Dynamic Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        .transition-layout { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .manual-input-active { border-color: #3b82f6 !important; background-color: #f0f7ff !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans">

<div id="navbar" class="bg-white border-b h-16 flex items-center px-4 justify-between shadow-sm sticky top-0 z-30">
    <div class="font-black text-blue-600 text-xl tracking-tighter">BOOTERSPACE</div>
    <div id="authStatus" class="text-sm text-gray-500 font-medium italic">Connecting...</div>
</div>

<!-- üîç SEARCH -->
<div class="bg-white border-b sticky top-16 z-20 shadow-sm">
    <div class="max-w-6xl mx-auto p-4 flex gap-2">
        <input id="searchInput" type="text" placeholder="Search by name, university, or city..." class="flex-1 border rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition" />
        <button id="searchBtn" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-sm font-bold hover:bg-blue-700 transition shadow-md">Search</button>
    </div>
</div>

<div id="mainContainer" class="flex-1 max-w-6xl mx-auto p-4 w-full">
    <div id="gridWrapper" class="grid grid-cols-1 gap-6 transition-layout">
        
        <!-- SEARCH RESULTS -->
        <div id="leftPanel" class="hidden opacity-0 transform -translate-x-4 transition-all duration-500">
            <div id="resultsHeader" class="mb-4 flex justify-between items-center hidden">
                <h3 class="font-bold text-gray-700">Search Results</h3>
                <span id="resultsCount" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">0</span>
            </div>
            <div id="resultsView" class="space-y-4"></div>
        </div>

        <!-- PROFILE CARD -->
        <div id="rightPanel" class="w-full max-w-2xl mx-auto transition-layout">
            <div id="myProfileCard" class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden opacity-0 transition-opacity duration-700">
                <div class="h-32 bg-gradient-to-r from-blue-600 to-indigo-700"></div>
                <div class="px-8 pb-8 relative">
                    <div class="relative -mt-12 mb-4 flex justify-center lg:justify-start">
                        <img id="myPhoto" src="" class="w-28 h-28 rounded-2xl border-4 border-white shadow-lg bg-gray-100 object-cover">
                    </div>
                    
                    <div class="flex flex-col lg:flex-row justify-between items-start gap-4">
                        <div class="flex-1">
                            <h1 id="myName" class="text-2xl font-black text-gray-900">Loading...</h1>
                            <p id="myRole" class="text-blue-600 font-bold text-sm"></p>
                            <p id="myLoc" class="text-gray-400 text-xs font-medium mt-1"></p>
                        </div>
                        <button onclick="openEditModal()" class="bg-gray-100 text-gray-700 px-5 py-2 rounded-xl text-sm font-bold hover:bg-gray-200 transition">Edit Profile</button>
                    </div>

                    <div id="myBio" class="mt-6 text-gray-500 text-sm italic leading-relaxed border-l-4 border-blue-100 pl-4"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8 pt-8 border-t border-gray-50">
                        <div class="p-4 bg-gray-50 rounded-2xl">
                            <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Education</span>
                            <p id="myEduDisp" class="text-gray-800 font-bold text-sm mt-1">--</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-2xl">
                            <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Personal Info</span>
                            <p id="myPersDisp" class="text-gray-800 font-bold text-sm mt-1">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üìù DYNAMIC EDIT MODAL -->
<div id="editModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="p-6 border-b flex justify-between items-center bg-gray-50">
            <h3 class="font-black text-gray-800">Professional Profile</h3>
            <button onclick="closeEditModal()" class="text-gray-400 text-2xl">&times;</button>
        </div>
        
        <div class="p-8 space-y-6 overflow-y-auto custom-scrollbar flex-1">
            <!-- Basic Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Full Name</label>
                    <input id="editName" type="text" class="w-full border rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Birthday</label>
                    <input id="editDob" type="date" class="w-full border rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Marital Status</label>
                    <select id="editMarital" class="w-full border rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="Single">Single</option>
                        <option value="Married">Married</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Bio -->
            <div>
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">About Me</label>
                <textarea id="editBio" rows="3" class="w-full border rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
            </div>

            <!-- üìç Location Section (Dynamic Firestore + Manual Override) -->
            <div class="bg-blue-50/50 p-6 rounded-2xl border border-blue-100 space-y-5">
                <div class="flex items-center justify-between">
                    <h4 class="text-xs font-black text-blue-700 uppercase tracking-widest">Location & Nationality</h4>
                    <span class="text-[10px] text-blue-400">Click ‚úèÔ∏è for manual entry</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Country -->
                    <div class="relative group">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Country</label>
                            <button onclick="toggleManual('Country')" class="text-blue-500 hover:text-blue-700 text-xs">‚úèÔ∏è</button>
                        </div>
                        <select id="selectCountry" onchange="onCountryChange()" class="w-full border-2 border-white rounded-xl p-3 text-sm focus:border-blue-500 outline-none transition shadow-sm bg-white"></select>
                        <input id="manualCountry" type="text" class="hidden w-full border-2 border-white rounded-xl p-3 text-sm focus:border-blue-500 outline-none shadow-sm manual-input-active" placeholder="Type Country...">
                    </div>

                    <!-- State -->
                    <div class="relative group">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">State</label>
                            <button onclick="toggleManual('State')" class="text-blue-500 hover:text-blue-700 text-xs">‚úèÔ∏è</button>
                        </div>
                        <select id="selectState" onchange="onStateChange()" class="w-full border-2 border-white rounded-xl p-3 text-sm focus:border-blue-500 outline-none transition shadow-sm bg-white"></select>
                        <input id="manualState" type="text" class="hidden w-full border-2 border-white rounded-xl p-3 text-sm focus:border-blue-500 outline-none shadow-sm manual-input-active" placeholder="Type State...">
                    </div>

                    <!-- City -->
                    <div class="relative group">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">City</label>
                            <button onclick="toggleManual('City')" class="text-blue-500 hover:text-blue-700 text-xs">‚úèÔ∏è</button>
                        </div>
                        <select id="selectCity" class="w-full border-2 border-white rounded-xl p-3 text-sm focus:border-blue-500 outline-none transition shadow-sm bg-white"></select>
                        <input id="manualCity" type="text" class="hidden w-full border-2 border-white rounded-xl p-3 text-sm focus:border-blue-500 outline-none shadow-sm manual-input-active" placeholder="Type City...">
                    </div>
                </div>
            </div>

            <!-- Work/Edu -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">University</label>
                    <input id="editUni" type="text" class="w-full border rounded-xl p-3 text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Position</label>
                    <input id="editPos" type="text" class="w-full border rounded-xl p-3 text-sm outline-none">
                </div>
            </div>
        </div>

        <div class="p-6 bg-gray-50 border-t flex gap-3">
            <button onclick="closeEditModal()" class="flex-1 py-3 font-bold text-gray-400 uppercase text-xs">Cancel</button>
            <button id="saveBtn" onclick="saveProfile()" class="flex-2 bg-blue-600 text-white px-8 py-3 rounded-2xl font-black uppercase text-xs shadow-lg hover:bg-blue-700 transition">Save Profile</button>
        </div>
    </div>
</div>

<script>
/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
    apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
    authDomain: "kar-kardan.firebaseapp.com",
    projectId: "kar-kardan",
    storageBucket: "kar-kardan.firebasestorage.app",
    messagingSenderId: "554147696994",
    appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const state = {
    user: null,
    profile: {},
    manualEntry: { Country: false, State: false, City: false }
};

/* ================= AUTH LISTEN ================= */
auth.onAuthStateChanged(user => {
    state.user = user;
    if (user) {
        document.getElementById('authStatus').innerText = "Logged In";
        loadUserProfile(user.uid);
    } else {
        document.getElementById('authStatus').innerText = "Guest Mode";
    }
});

async function loadUserProfile(uid) {
    const doc = await db.collection("users").doc(uid).get();
    if (doc.exists) {
        state.profile = doc.data();
        renderProfile();
    }
    document.getElementById('myProfileCard').classList.remove('opacity-0');
}

function renderProfile() {
    const p = state.profile;
    document.getElementById('myName').innerText = p.fullName || "New Voyager";
    document.getElementById('myRole').innerText = p.position || "Member";
    document.getElementById('myLoc').innerText = `${p.city || '...'}, ${p.country || 'Global'}`;
    document.getElementById('myBio').innerText = p.bio || "No summary added yet.";
    document.getElementById('myEduDisp').innerText = p.university || "--";
    document.getElementById('myPersDisp').innerText = `${p.dob || '--'} | ${p.maritalStatus || '--'}`;
    document.getElementById('myPhoto').src = p.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${state.user.uid}`;
}

/* ================= DYNAMIC LOCATION SYSTEM ================= */
// Paths defined by environment rules
const getPublicCollection = (col) => db.collection('artifacts', 'default-app-id', 'public', 'data', col);

async function loadCountries() {
    const select = document.getElementById('selectCountry');
    select.innerHTML = '<option value="">Loading...</option>';
    
    try {
        const snapshot = await getPublicCollection('countries').get();
        select.innerHTML = '<option value="">Select Country</option>';
        snapshot.forEach(doc => {
            select.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
        });
    } catch (e) { 
        select.innerHTML = '<option value="">No list found</option>'; 
    }
}

async function onCountryChange() {
    const countryId = document.getElementById('selectCountry').value;
    const stateSelect = document.getElementById('selectState');
    stateSelect.innerHTML = '<option value="">Loading States...</option>';
    
    try {
        const snapshot = await getPublicCollection('countries').doc(countryId).collection('states').get();
        stateSelect.innerHTML = '<option value="">Select State</option>';
        snapshot.forEach(doc => {
            stateSelect.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
        });
    } catch (e) {
        stateSelect.innerHTML = '<option value="">No states</option>';
    }
}

async function onStateChange() {
    const countryId = document.getElementById('selectCountry').value;
    const stateId = document.getElementById('selectState').value;
    const citySelect = document.getElementById('selectCity');
    citySelect.innerHTML = '<option value="">Loading Cities...</option>';
    
    try {
        const snapshot = await getPublicCollection('countries').doc(countryId).collection('states').doc(stateId).collection('cities').get();
        citySelect.innerHTML = '<option value="">Select City</option>';
        snapshot.forEach(doc => {
            citySelect.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
        });
    } catch (e) {
        citySelect.innerHTML = '<option value="">No cities</option>';
    }
}

function toggleManual(type) {
    state.manualEntry[type] = !state.manualEntry[type];
    const select = document.getElementById(`select${type}`);
    const input = document.getElementById(`manual${type}`);
    
    if (state.manualEntry[type]) {
        select.classList.add('hidden');
        input.classList.remove('hidden');
        input.focus();
    } else {
        select.classList.remove('hidden');
        input.classList.add('hidden');
    }
}

/* ================= MODAL LOGIC ================= */
function openEditModal() {
    const p = state.profile;
    document.getElementById('editName').value = p.fullName || "";
    document.getElementById('editDob').value = p.dob || "";
    document.getElementById('editMarital').value = p.maritalStatus || "Single";
    document.getElementById('editBio').value = p.bio || "";
    document.getElementById('editUni').value = p.university || "";
    document.getElementById('editPos').value = p.position || "";
    
    loadCountries().then(() => {
        // Pre-fill location logic if needed
    });
    
    document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

async function saveProfile() {
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.innerText = "SAVING...";

    const getVal = (type) => {
        return state.manualEntry[type] 
            ? document.getElementById(`manual${type}`).value 
            : document.getElementById(`select${type}`).value;
    };

    const data = {
        fullName: document.getElementById('editName').value,
        dob: document.getElementById('editDob').value,
        maritalStatus: document.getElementById('editMarital').value,
        bio: document.getElementById('editBio').value,
        university: document.getElementById('editUni').value,
        position: document.getElementById('editPos').value,
        country: getVal('Country'),
        state: getVal('State'),
        city: getVal('City'),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection("users").doc(state.user.uid).set(data, { merge: true });
        state.profile = { ...state.profile, ...data };
        renderProfile();
        closeEditModal();
    } catch (e) {
        console.error(e);
        alert("Save failed. Check permissions.");
    } finally {
        btn.disabled = false;
        btn.innerText = "Save Profile";
    }
}

/* ================= SEARCH (RE-USE) ================= */
document.getElementById('searchBtn').onclick = async () => {
    const q = document.getElementById('searchInput').value.toLowerCase().trim();
    if(!q) return;

    const lp = document.getElementById('leftPanel');
    const rp = document.getElementById('rightPanel');
    const rv = document.getElementById('resultsView');

    lp.classList.remove('hidden');
    setTimeout(() => lp.classList.replace('opacity-0', 'opacity-100'), 50);
    document.getElementById('gridWrapper').classList.replace('grid-cols-1', 'lg:grid-cols-3');
    rp.classList.replace('max-w-2xl', 'lg:col-span-1');

    rv.innerHTML = '<div class="p-8 text-center text-gray-400">Searching global network...</div>';
    
    try {
        const snap = await db.collection("users").get();
        rv.innerHTML = "";
        let count = 0;
        snap.forEach(doc => {
            const u = doc.data();
            const text = `${u.fullName} ${u.university} ${u.city}`.toLowerCase();
            if(text.includes(q)) {
                count++;
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl border flex gap-4 items-center hover:border-blue-500 cursor-pointer transition";
                card.innerHTML = `
                    <img src="${u.photoURL || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+doc.id}" class="w-12 h-12 rounded-xl">
                    <div>
                        <p class="font-bold text-gray-800">${u.fullName}</p>
                        <p class="text-[10px] text-gray-400 uppercase font-black">${u.city || 'Global'}</p>
                    </div>
                `;
                rv.appendChild(card);
            }
        });
        document.getElementById('resultsHeader').classList.remove('hidden');
        document.getElementById('resultsCount').innerText = count;
    } catch(e) {}
}
</script>
</body>
</html>
