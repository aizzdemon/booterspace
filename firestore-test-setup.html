<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BooterSpace â€“ Firestore Test Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body style="font-family: Arial; padding:20px">

<h2>ğŸ”¥ BooterSpace Firestore Test Page</h2>

<!-- AUTH -->
<h3>ğŸ” Login</h3>
<input id="email" placeholder="Email"><br><br>
<input id="password" type="password" placeholder="Password"><br><br>
<button onclick="login()">Login / Register</button>

<hr>

<!-- CONNECTION -->
<h3>ğŸ”— Connection Request</h3>
<input id="toUid" placeholder="Target User UID"><br><br>
<button onclick="sendConnection()">Send Request</button>
<button onclick="loadRequests()">Load Received Requests</button>

<ul id="requests"></ul>

<hr>

<!-- CHAT -->
<h3>ğŸ’¬ Chat Test</h3>
<input id="chatId" placeholder="Chat ID"><br><br>
<input id="message" placeholder="Message text"><br><br>
<button onclick="sendMessage()">Send Message</button>

<hr>

<!-- LOG -->
<h3>ğŸ“œ Log</h3>
<pre id="log"></pre>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query,
  where, getDocs, updateDoc, doc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ğŸ”§ CONFIG */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
const log = m => document.getElementById("log").textContent += m + "\n";

/* ğŸ” AUTH */
window.login = async () => {
  const email = email.value;
  const password = password.value;

  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch {
    await createUserWithEmailAndPassword(auth, email, password);
  }
};

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    log("âœ… Logged in: " + user.uid);
  }
});

/* ğŸ”— SEND CONNECTION */
window.sendConnection = async () => {
  await addDoc(collection(db, "connections"), {
    fromUid: currentUser.uid,
    toUid: toUid.value,
    status: "pending",
    createdAt: serverTimestamp()
  });
  log("ğŸ“¨ Connection request sent");
};

/* ğŸ“¥ LOAD RECEIVED */
window.loadRequests = async () => {
  requests.innerHTML = "";

  const q = query(
    collection(db, "connections"),
    where("toUid", "==", currentUser.uid),
    where("status", "==", "pending")
  );

  const snap = await getDocs(q);

  snap.forEach(d => {
    const li = document.createElement("li");
    li.innerHTML = `
      From: ${d.data().fromUid}
      <button onclick="accept('${d.id}','${d.data().fromUid}')">Accept</button>
    `;
    requests.appendChild(li);
  });
};

/* âœ… ACCEPT + CREATE CHAT */
window.accept = async (connectionId, fromUid) => {
  await updateDoc(doc(db, "connections", connectionId), {
    status: "accepted"
  });

  const chat = await addDoc(collection(db, "chats"), {
    members: [currentUser.uid, fromUid],
    createdAt: serverTimestamp(),
    lastMessage: "",
    lastMessageAt: serverTimestamp()
  });

  // ğŸ”” Notification doc (for testing)
  await addDoc(collection(db, "notifications"), {
    toUid: fromUid,
    type: "connection_accepted",
    message: "Your connection request was accepted",
    createdAt: serverTimestamp()
  });

  log("âœ… Accepted | Chat ID: " + chat.id);
};

/* ğŸ’¬ SEND MESSAGE */
window.sendMessage = async () => {
  await addDoc(
    collection(db, "chats", chatId.value, "messages"),
    {
      senderId: currentUser.uid,
      text: message.value,
      createdAt: serverTimestamp()
    }
  );

  await updateDoc(doc(db, "chats", chatId.value), {
    lastMessage: message.value,
    lastMessageAt: serverTimestamp()
  });

  log("ğŸ’¬ Message sent");
};
</script>

</body>
</html>
