<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Chat - BooterSpace</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  setDoc,
  addDoc,
  updateDoc,
  getDoc,
  getDocs,
  query,
  where,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I","authDomain":"kar-kardan.firebaseapp.com","projectId":"kar-kardan","storageBucket":"kar-kardan.appspot.com","messagingSenderId":"554147696994","appId":"1:554147696994:web:221dcb883e3b65dcea5c3b"}');

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.db = db;
window.auth = auth;

let currentUser = null;
let activeChatId = null;
let activeRecipient = null;
let chatUnsubscribe = null;
let currentTab = 'chats';
let userRequests = [];
let allConversations = [];
let suggestedUsers = [];

/* ------------------ HELPERS ------------------ */

const chatIdFor = (a,b)=>[a,b].sort().join('_');
const connectionsCol = ()=>collection(db,'connections');
const chatsCol = ()=>collection(db,'chats');
const messagesCol = id=>collection(db,'chats',id,'messages');
const notificationsCol = uid=>collection(db,'notifications',uid,'items');

/* ------------------ AUTH ------------------ */

onAuthStateChanged(auth, async user=>{
  currentUser=user;
  if(!user) await signInAnonymously(auth);
  if(user && !user.isAnonymous){
    setupRequestsListener();
    loadConversations();
    loadSuggestions();
  } else loadSuggestions();
});

/* ------------------ CONNECTIONS ------------------ */

function setupRequestsListener(){
  const q1=query(connectionsCol(),where('from','==',currentUser.uid));
  const q2=query(connectionsCol(),where('to','==',currentUser.uid));
  const map=new Map();
  const sync=s=>{
    s.docChanges().forEach(c=>{
      if(c.type==='removed') map.delete(c.doc.id);
      else map.set(c.doc.id,{id:c.doc.id,...c.doc.data()});
    });
    userRequests=[...map.values()];
    if(currentTab==='suggest') renderSuggestedUI();
    if(currentTab==='new-chat') renderNewChatUI();
  };
  onSnapshot(q1,sync); onSnapshot(q2,sync);
}

async function sendRequest(uid,name){
  const id=chatIdFor(currentUser.uid,uid);
  await setDoc(doc(db,'connections',id),{
    from:currentUser.uid,
    to:uid,
    status:'pending',
    createdAt:serverTimestamp()
  });
}

async function acceptRequest(id){
  await updateDoc(doc(db,'connections',id),{status:'accepted'});
}

/* ------------------ CHAT ------------------ */

async function startChat(uid){
  const snap=await getDoc(doc(db,'users',uid));
  activeRecipient={id:uid,...snap.data()};
  activeChatId=chatIdFor(currentUser.uid,uid);

  await setDoc(doc(db,'chats',activeChatId),{
    participants:[currentUser.uid,uid],
    createdAt:serverTimestamp()
  },{merge:true});

  chatUnsubscribe?.();
  chatUnsubscribe=onSnapshot(messagesCol(activeChatId),s=>{
    renderMessages(s.docs.map(d=>d.data()));
  });
}

window.sendMessage=async()=>{
  const input=document.getElementById('chat-input');
  const text=input.value.trim();
  if(!text) return;
  input.value='';
  await addDoc(messagesCol(activeChatId),{
    text,
    senderId:currentUser.uid,
    createdAt:serverTimestamp()
  });
  await updateDoc(doc(db,'chats',activeChatId),{
    lastMessage:text,
    lastMessageAt:serverTimestamp()
  });
};

/* ------------------ LISTENERS ------------------ */

function loadConversations(){
  const q=query(chatsCol(),where('participants','array-contains',currentUser.uid));
  onSnapshot(q,s=>{
    allConversations=s.docs.map(d=>({id:d.id,...d.data()}));
    renderConversations();
  });
}

/* ------------------ USERS ------------------ */

async function loadSuggestions(){
  const snap=await getDocs(collection(db,'users'));
  suggestedUsers=snap.docs.map(d=>({id:d.id,...d.data()}))
    .filter(u=>!currentUser || u.id!==currentUser.uid);
  renderSuggestedUI();
}

/* ------------------ UI ------------------ */

function renderMessages(msgs){
  const box=document.getElementById('messages-container');
  box.innerHTML=msgs.map(m=>{
    const mine=m.senderId===currentUser.uid;
    return `<div class="flex ${mine?'justify-end':'justify-start'} mb-2">
      <div class="px-3 py-2 rounded-xl ${mine?'bg-indigo-600 text-white':'bg-white border'}">
        ${m.text}
      </div>
    </div>`;
  }).join('');
  box.scrollTop=box.scrollHeight;
}

function renderConversations(){
  const list=document.getElementById('conversation-list');
  list.innerHTML=allConversations.map(c=>{
    const other=c.participants.find(p=>p!==currentUser.uid);
    return `<div onclick="startChat('${other}')" class="p-4 border-b cursor-pointer">
      Chat with ${other}
    </div>`;
  }).join('');
}

function renderSuggestedUI(){
  const list=document.getElementById('suggestion-list');
  list.innerHTML=suggestedUsers.map(u=>{
    return `<div class="p-4 border-b flex justify-between">
      ${u.fullName||'User'}
      <button onclick="sendRequest('${u.id}')">+</button>
    </div>`;
  }).join('');
}

function renderNewChatUI(){
  const list=document.getElementById('new-chat-list');
  const connected=userRequests.filter(r=>r.status==='accepted')
    .map(r=>r.from===currentUser.uid?r.to:r.from);
  const users=suggestedUsers.filter(u=>connected.includes(u.id));
  list.innerHTML=users.map(u=>`
    <div onclick="startChat('${u.id}')" class="p-4 border-b">
      ${u.fullName||'User'}
    </div>`).join('');
}

window.startChat=startChat;
window.switchTab=(t)=>currentTab=t;
</script>

    <style>
        :root {
            --vh: 1vh;
        }
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .main-container {
            height: 100%;
            height: calc(var(--vh, 1vh) * 100);
            display: flex;
            flex-direction: column;
        }
        .app-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            width: 100%;
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .fab-btn {
            position: absolute;
            bottom: 24px;
            right: 24px;
            z-index: 40;
        }
        @media (max-width: 768px) {
            .app-content {
                padding: 0 !important;
            }
            .chat-box-rounded {
                border-radius: 0 !important;
                border: none !important;
            }
            #messages-container {
                padding-bottom: 20px;
            }
        }
    </style>
    <script>
        const updateVH = () => {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        };
        window.addEventListener('resize', updateVH);
        updateVH();
    </script>
</head>
<body class="bg-slate-50 font-sans text-slate-900 main-container">

<div id="navbar-placeholder"></div>

<main class="app-content max-w-7xl mx-auto w-full md:p-4 lg:p-6">
    <div class="flex-1 flex bg-white md:rounded-3xl chat-box-rounded shadow-2xl md:border border-slate-200 overflow-hidden relative">
        
        <!-- Sidebar -->
        <aside id="sidebar-panel" class="w-full md:w-80 lg:w-96 border-r flex flex-col bg-white overflow-hidden">
            <div class="p-4 border-b">
                <div class="relative">
                    <input id="sidebar-search" type="text" oninput="handleSearch(event)" placeholder="Search messages..." class="w-full bg-slate-100 border-none rounded-xl py-3 pl-10 pr-4 text-sm focus:ring-2 focus:ring-indigo-500 transition-all">
                    <svg class="w-4 h-4 text-slate-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b bg-slate-50/50">
                <button id="tab-chats" onclick="switchTab('chats')" class="flex-1 py-4 text-[11px] font-black uppercase tracking-widest text-indigo-600 border-b-2 border-indigo-600 transition-all">
                    Chats
                </button>
                <button id="tab-suggest" onclick="switchTab('suggest')" class="flex-1 py-4 text-[11px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-all">
                    Discover
                </button>
            </div>
            
            <div id="conversation-list" class="flex-1 overflow-y-auto"></div>
            
            <div id="suggest-tab-content" class="flex-1 flex flex-col overflow-hidden hidden">
                <div class="px-4 py-3 bg-slate-50 flex justify-between items-center border-b">
                    <span class="text-[10px] font-black uppercase text-slate-500">Find New Makers</span>
                    <button onclick="loadSuggestions()" class="text-[10px] text-indigo-600 font-bold hover:underline uppercase">Shuffle</button>
                </div>
                <div id="suggestion-list" class="flex-1 overflow-y-auto"></div>
            </div>

            <div id="new-chat-content" class="flex-1 flex flex-col overflow-hidden hidden">
                <div class="px-4 py-3 bg-indigo-50 flex justify-between items-center border-b">
                    <span class="text-[10px] font-black uppercase text-indigo-600">New Conversation</span>
                    <button onclick="switchTab('chats')" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div id="new-chat-list" class="flex-1 overflow-y-auto"></div>
            </div>

            <button onclick="switchTab('new-chat')" class="fab-btn w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center active:scale-95 transition-transform hover:bg-indigo-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
            </button>
        </aside>

        <!-- Chat Area -->
        <section id="chat-panel" class="hidden md:flex flex-1 flex-col relative bg-slate-50/30 overflow-hidden">
            <div id="chat-placeholder" class="flex-1 flex flex-col items-center justify-center p-12 text-center">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-200 rounded-full flex items-center justify-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
                    </svg>
                </div>
                <h3 class="text-xl font-black text-slate-800">BooterSpace Chat</h3>
                <p class="text-slate-500 max-w-xs mx-auto mt-2 text-sm">Select a recent chat or click the <span class="text-indigo-600 font-bold">+</span> button to start a new one with your connections.</p>
                <button onclick="switchTab('suggest')" class="mt-4 px-6 py-2 bg-indigo-600 text-white text-xs font-bold rounded-full shadow-md hover:bg-indigo-700 transition-all">Find New People</button>
            </div>

            <div id="chat-window" class="hidden flex-1 flex flex-col h-full bg-white">
                <header class="px-4 py-3 md:px-6 md:py-4 bg-white border-b flex items-center gap-3 shadow-sm z-10">
                    <button onclick="closeChatMobile()" class="md:hidden p-2 -ml-2 text-slate-400 hover:text-slate-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div id="recipient-avatar" class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-sm">?</div>
                    <div class="flex-1 min-w-0">
                        <h3 id="recipient-name" class="font-bold text-slate-800 leading-tight truncate">User</h3>
                        <p class="text-[10px] text-green-500 font-bold uppercase tracking-wider">Online</p>
                    </div>
                </header>

                <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 flex flex-col bg-slate-50/50"></div>

                <footer class="p-2.5 md:p-3 bg-white border-t">
                    <div class="flex items-end gap-2 bg-slate-100/80 rounded-xl border border-slate-200 p-1 md:p-1.5">
                        <textarea id="chat-input" rows="1" placeholder="Type a message..." class="flex-1 bg-transparent border-none focus:ring-0 px-2 py-1.5 text-[13px] resize-none overflow-hidden max-h-24" onkeydown="if(event.key === 'Enter' && !event.shiftKey && window.innerWidth > 768){ event.preventDefault(); sendMessage(); }"></textarea>
                        <button onclick="sendMessage()" class="bg-indigo-600 text-white p-2 rounded-lg transition-all active:scale-90 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                        </button>
                    </div>
                    <div class="h-1 md:hidden"></div>
                </footer>
            </div>
        </section>
    </div>
</main>

</body>
</html>
