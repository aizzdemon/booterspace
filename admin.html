<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äì KARDAN</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); }
        .nav-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; }
        .user-card.new-user { border-left: 4px solid #10b981; background-color: #f0fdf4; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); z-index: 50; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }

        /* Dropdown Styles */
        .dropdown-content { display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 40; margin-top: 0.5rem; overflow: hidden; }
        .dropdown:hover .dropdown-content { display: block; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .filter-btn-active { background-color: white; border-color: #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); color: #4f46e5; font-weight: 700; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

<!-- UNIVERSAL EDIT MODAL -->
<div id="editModal" class="modal">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
        <div class="p-6 border-b flex justify-between items-center bg-slate-50">
            <h3 id="modalTitle" class="font-black text-slate-800">Edit Details</h3>
            <button onclick="closeModal('editModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        <div class="p-6 max-h-[70vh] overflow-y-auto">
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editDocId">
                <input type="hidden" id="editCollectionName">
                <div id="dynamicFields" class="space-y-4"></div>
            </form>
        </div>
        <div class="p-6 border-t bg-slate-50 flex gap-3 justify-end">
            <button onclick="closeModal('editModal')" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-lg">Cancel</button>
            <button id="saveBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition">Save Changes</button>
        </div>
    </div>
</div>

<!-- CREATE JOB MODAL -->
<div id="createJobModal" class="modal">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
        <div class="p-6 border-b flex justify-between items-center bg-slate-50">
            <div>
                <h3 class="font-black text-slate-800">Create New Job Posting</h3>
                <p class="text-[10px] text-amber-600 font-bold uppercase tracking-wider">Manual entry from Admin</p>
            </div>
            <button onclick="closeModal('createJobModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        <div class="p-6 max-h-[70vh] overflow-y-auto">
            <form id="jobForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Job Title</label>
                    <input id="jobTitle" type="text" placeholder="e.g. Senior Developer" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Company Name</label>
                        <input id="companyName" type="text" placeholder="Kardan Inc" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Location</label>
                        <input id="jobPlace" type="text" placeholder="Remote / Kabul" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Salary</label>
                        <input id="salary" type="text" placeholder="e.g. $50k - $70k" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Application Link</label>
                        <input id="jobLink" type="url" placeholder="https://..." class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Job Description</label>
                    <textarea id="jobDescription" rows="4" placeholder="Briefly describe the role..." class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                </div>
            </form>
        </div>
        <div class="p-6 border-t bg-slate-50 flex gap-3 justify-end">
            <button onclick="closeModal('createJobModal')" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-lg">Cancel</button>
            <button id="publishJobBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition">Publish Immediately</button>
        </div>
    </div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginDiv" class="flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black text-indigo-600">KARDAN</h1>
            <p class="text-slate-500 font-medium">Administrative Gateway</p>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-1">Admin Email</label>
                <input id="email" type="email" placeholder="admin@kardan.com" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition"/>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Password</label>
                <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition"/>
            </div>
            <button id="loginBtn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">Authorize Access</button>
            <p id="loginError" class="text-red-500 text-sm text-center mt-2 font-medium"></p>
        </div>
    </div>
</div>

<!-- ADMIN INTERFACE -->
<div id="adminDiv" class="hidden pb-20">
    <header class="bg-white border-b sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl font-black text-indigo-600">KARDAN</span>
                <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold">ADMIN</span>
            </div>
            <button id="logoutBtn" class="text-sm font-bold text-slate-500 hover:text-red-600 transition">Logout</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Quick Stats Banner -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white border border-slate-200 p-5 rounded-2xl shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-2xl">üë•</div>
                <div><p class="text-xs font-bold text-slate-400 uppercase">Users</p><h3 id="stat-totalUsers" class="text-2xl font-black text-slate-800">--</h3></div>
            </div>
            <div class="bg-white border border-slate-200 p-5 rounded-2xl shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center text-2xl">üíº</div>
                <div><p class="text-xs font-bold text-slate-400 uppercase">Active</p><h3 id="stat-totalJobs" class="text-2xl font-black text-slate-800">--</h3></div>
            </div>
            <div class="bg-white border border-slate-200 p-5 rounded-2xl shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center text-2xl">‚è≥</div>
                <div><p class="text-xs font-bold text-slate-400 uppercase">Review</p><h3 id="stat-pendingJobs" class="text-2xl font-black text-slate-800">--</h3></div>
            </div>
        </div>

        <!-- Navigation Tab Selection -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <!-- CONSOLIDATED JOBS DROPDOWN -->
            <div class="relative dropdown">
                <button class="w-full bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center group">
                    <span class="text-2xl group-hover:scale-110 transition">üíº</span>
                    <span class="text-sm font-bold mt-2">Jobs Management</span>
                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Click to view options</span>
                </button>
                <div class="dropdown-content border border-slate-200 shadow-xl">
                    <button data-tab="jobs" class="nav-btn-tab w-full text-left px-6 py-4 hover:bg-slate-50 border-b flex justify-between items-center transition">
                        <span class="font-bold text-slate-700">Approved (Active)</span>
                        <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-black">LIVE</span>
                    </button>
                    <button data-tab="pendingJobs" class="nav-btn-tab w-full text-left px-6 py-4 hover:bg-slate-50 border-b flex justify-between items-center transition">
                        <span class="font-bold text-slate-700">Pending Review</span>
                        <span class="text-[10px] bg-amber-100 text-amber-700 px-2 py-1 rounded font-black">QUEUED</span>
                    </button>
                    <button id="addJobDirect" class="w-full text-left px-6 py-4 hover:bg-indigo-50 text-indigo-600 font-bold transition">
                        + Create New Posting
                    </button>
                </div>
            </div>

            <button data-tab="users" class="nav-btn-tab bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center group">
                <span class="text-2xl group-hover:scale-110 transition">üë•</span>
                <span class="text-sm font-bold mt-2">Manage Users</span>
            </button>
            <button data-tab="posts" class="nav-btn-tab bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center group">
                <span class="text-2xl group-hover:scale-110 transition">üí¨</span>
                <span class="text-sm font-bold mt-2">Community Posts</span>
            </button>
        </div>

        <div id="content" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 min-h-[400px]">
            <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                <span class="text-5xl mb-4">üñ•Ô∏è</span>
                <p class="font-medium">Welcome to the Kardan HQ Command Center.</p>
            </div>
        </div>
    </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, collection, query, where, orderBy, onSnapshot, deleteDoc, updateDoc, addDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
    authDomain: "kar-kardan.firebaseapp.com",
    projectId: "kar-kardan",
    storageBucket: "kar-kardan.firebasestorage.app",
    messagingSenderId: "554147696994",
    appId: "1:554147696994:web:221dcb883e3b65dcea5c3b",
    measurementId: "G-RRC3X485KQ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_UID = "nkXAUBb7ffZQ5CtyShWl6YcQ39t2";
let currentListUnsubscribe = null;
let userFilterMode = 'all';

/* ============================
   Helper Functions
============================ */
function downloadCSV(data, filename) {
    if (!data.length) return alert("No data to export");
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(h => {
            const val = row[h] instanceof Timestamp ? row[h].toDate().toISOString() : (row[h] || '');
            return `"${('' + val).replace(/"/g, '""')}"`;
        }).join(','))
    ].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
}

function formatDate(timestamp) {
    if (!timestamp) return 'No Date';
    return (timestamp.toDate ? timestamp.toDate() : new Date(timestamp)).toLocaleDateString();
}

/* ============================
   Auth Logic
============================ */
onAuthStateChanged(auth, user => {
    if (user && user.uid === ADMIN_UID) {
        document.getElementById("loginDiv").classList.add("hidden");
        document.getElementById("adminDiv").classList.remove("hidden");
        initGlobalStats();
    } else {
        document.getElementById("loginDiv").classList.remove("hidden");
        document.getElementById("adminDiv").classList.add("hidden");
    }
});

function initGlobalStats() {
    onSnapshot(collection(db, "jobs"), snap => {
        const docs = snap.docs.map(d => d.data());
        document.getElementById("stat-totalJobs").innerText = docs.filter(j => j.status === 'approved').length;
        document.getElementById("stat-pendingJobs").innerText = docs.filter(j => j.status === 'pending').length;
    });
    onSnapshot(collection(db, "users"), snap => document.getElementById("stat-totalUsers").innerText = snap.size);
}

/* ============================
   Tabs Logic
============================ */
function showJobsTab() {
    const content = document.getElementById("content");
    content.innerHTML = `
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">Approved Job Listings</h2>
            <button id="dlJobs" class="text-xs bg-slate-100 px-3 py-1.5 rounded-lg font-bold hover:bg-slate-200">Export CSV</button>
        </div>
        <div id="list" class="space-y-3">Loading...</div>
    `;
    if (currentListUnsubscribe) currentListUnsubscribe();
    const q = query(collection(db, "jobs"), where("status", "==", "approved"), orderBy("timestamp", "desc"));
    currentListUnsubscribe = onSnapshot(q, snap => {
        const container = document.getElementById("list");
        container.innerHTML = snap.empty ? `<p class="text-center py-10 text-slate-400">No active jobs.</p>` : "";
        const raw = snap.docs.map(d => ({id: d.id, ...d.data()}));
        document.getElementById("dlJobs").onclick = () => downloadCSV(raw, "active_jobs.csv");
        
        snap.forEach(d => {
            const j = d.data();
            const div = document.createElement('div');
            div.className = "p-4 border rounded-xl flex justify-between items-center hover:bg-slate-50 transition";
            div.innerHTML = `
                <div>
                    <h4 class="font-bold text-sm">${j.title}</h4>
                    <p class="text-xs text-slate-500">${j.company} ‚Ä¢ ${j.jobPlace || 'Remote'}</p>
                    <p class="text-[10px] text-indigo-600 font-bold mt-1">Posted By: ${j.userEmail || 'Admin'}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="editDoc('jobs', '${d.id}')" class="text-xs font-bold text-slate-400 hover:text-indigo-600">Edit</button>
                    <button onclick="deleteDocById('jobs', '${d.id}')" class="text-xs font-bold text-red-400">Delete</button>
                </div>
            `;
            container.appendChild(div);
        });
    });
}

function showPendingJobsTab() {
    const content = document.getElementById("content");
    content.innerHTML = `
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-amber-600">Jobs Awaiting Review</h2>
            <button id="dlPending" class="text-xs bg-amber-50 px-3 py-1.5 rounded-lg font-bold hover:bg-amber-100">Export CSV</button>
        </div>
        <div id="list" class="space-y-3">Loading...</div>
    `;
    if (currentListUnsubscribe) currentListUnsubscribe();
    const q = query(collection(db, "jobs"), where("status", "==", "pending"), orderBy("timestamp", "desc"));
    currentListUnsubscribe = onSnapshot(q, snap => {
        const container = document.getElementById("list");
        container.innerHTML = snap.empty ? `<p class="text-center py-10 text-slate-400">No pending reviews.</p>` : "";
        const raw = snap.docs.map(d => ({id: d.id, ...d.data()}));
        document.getElementById("dlPending").onclick = () => downloadCSV(raw, "pending_jobs.csv");

        snap.forEach(d => {
            const j = d.data();
            const div = document.createElement('div');
            div.className = "p-4 border border-amber-100 bg-amber-50 rounded-xl flex justify-between items-center";
            div.innerHTML = `
                <div>
                    <h4 class="font-bold text-sm">${j.title}</h4>
                    <p class="text-xs text-slate-600 font-medium">${j.company} ‚Ä¢ Posted By: ${j.userEmail || 'User'}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="updateStatus('${d.id}', 'approved')" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold">Approve</button>
                    <button onclick="deleteDocById('jobs', '${d.id}')" class="text-xs font-bold text-red-500 px-3">Reject</button>
                </div>
            `;
            container.appendChild(div);
        });
    });
}

function showUsersTab() {
    const content = document.getElementById("content");
    content.innerHTML = `
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">Community Members</h2>
            <button id="dlUsers" class="text-xs bg-slate-100 px-3 py-1.5 rounded-lg font-bold">Export Users</button>
        </div>
        <div id="list" class="grid grid-cols-1 md:grid-cols-2 gap-3">Loading...</div>
    `;
    if (currentListUnsubscribe) currentListUnsubscribe();
    currentListUnsubscribe = onSnapshot(query(collection(db, "users"), orderBy("createdAt", "desc")), snap => {
        const container = document.getElementById("list");
        container.innerHTML = "";
        const raw = snap.docs.map(d => ({id: d.id, ...d.data()}));
        document.getElementById("dlUsers").onclick = () => downloadCSV(raw, "kardan_users.csv");

        snap.forEach(d => {
            const u = d.data();
            const div = document.createElement('div');
            div.className = "p-4 border rounded-xl bg-white flex items-center justify-between";
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-xs">${(u.name || 'U').charAt(0)}</div>
                    <div><h4 class="font-bold text-sm">${u.name || 'User'}</h4><p class="text-[10px] text-slate-500">${u.email || 'No Email'}</p></div>
                </div>
                <button onclick="editDoc('users', '${d.id}')" class="text-[10px] font-bold text-indigo-600">Profile</button>
            `;
            container.appendChild(div);
        });
    });
}

/* ============================
   Actions
============================ */
async function editDoc(col, id) {
    const modal = document.getElementById("editModal");
    const container = document.getElementById("dynamicFields");
    document.getElementById("editDocId").value = id;
    document.getElementById("editCollectionName").value = col;
    modal.classList.add("active");
    container.innerHTML = "Fetching...";
    
    const snap = await getDoc(doc(db, col, id));
    if (snap.exists()) {
        const data = snap.data();
        container.innerHTML = "";
        Object.keys(data).forEach(k => {
            if (typeof data[k] === 'object' && !(data[k] instanceof Timestamp)) return;
            const div = document.createElement('div');
            div.innerHTML = `
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">${k}</label>
                <input type="text" data-key="${k}" value="${data[k] instanceof Timestamp ? data[k].toDate().toLocaleString() : (data[k] || '')}" class="w-full p-2 border rounded-lg text-sm bg-slate-50">
            `;
            container.appendChild(div);
        });
    }
}

async function updateStatus(id, status) {
    await updateDoc(doc(db, "jobs", id), { status });
}

async function deleteDocById(col, id) {
    if (confirm("Delete permanently?")) await deleteDoc(doc(db, col, id));
}

/* ============================
   Event Handlers
============================ */
document.getElementById("loginBtn").onclick = () => {
    const e = document.getElementById("email").value;
    const p = document.getElementById("password").value;
    signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById("loginError").innerText = err.message);
};

document.getElementById("logoutBtn").onclick = () => signOut(auth);
document.getElementById("addJobDirect").onclick = () => document.getElementById("createJobModal").classList.add("active");

document.getElementById("publishJobBtn").onclick = async () => {
    const payload = {
        title: document.getElementById("jobTitle").value,
        company: document.getElementById("companyName").value,
        jobPlace: document.getElementById("jobPlace").value,
        salary: document.getElementById("salary").value,
        jobLink: document.getElementById("jobLink").value,
        description: document.getElementById("jobDescription").value,
        status: 'approved',
        timestamp: serverTimestamp(),
        userName: "Administrator",
        userEmail: auth.currentUser?.email
    };
    await addDoc(collection(db, "jobs"), payload);
    document.getElementById("createJobModal").classList.remove("active");
    alert("Published!");
};

document.getElementById("saveBtn").onclick = async () => {
    const id = document.getElementById("editDocId").value;
    const col = document.getElementById("editCollectionName").value;
    const inputs = document.querySelectorAll("#dynamicFields input");
    const updates = {};
    inputs.forEach(i => updates[i.dataset.key] = i.value);
    await updateDoc(doc(db, col, id), updates);
    document.getElementById("editModal").classList.remove("active");
};

document.querySelectorAll('.nav-btn-tab').forEach(btn => {
    btn.onclick = () => {
        const tab = btn.dataset.tab;
        if (tab === 'jobs') showJobsTab();
        else if (tab === 'pendingJobs') showPendingJobsTab();
        else if (tab === 'users') showUsersTab();
        else document.getElementById("content").innerHTML = `<p class="text-center py-20 text-slate-400">Section in development.</p>`;
    };
});

window.closeModal = (id) => document.getElementById(id).classList.remove("active");
window.editDoc = editDoc;
window.updateStatus = updateStatus;
window.deleteDocById = deleteDocById;
</script>
</body>
</html>
